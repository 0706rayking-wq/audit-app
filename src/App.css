<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分店巡檢系統 v5.0 Pro</title>
    <!-- 1. 載入框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; }
            .print-border { border: 1px solid #000 !important; }
            .print-bg-gray { background-color: #f8fafc !important; -webkit-print-color-adjust: exact; }
        }
        select { appearance: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen">
    <div id="root"></div>

    <!-- 2. Firebase SDK 初始化 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // Firebase 部署配置區：請在此填入您自己的金鑰
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDkrlDh8S8OS5sCj7ZlKr6thQAWM7akcPk", 
            authDomain: "audit-system-c631b.firebaseapp.com", 
            projectId: "audit-system-c631b", 
            storageBucket: "audit-system-c631b.firebasestorage.app",
            messagingSenderId: "160351531948",
            appId: "1:160351531948:web:ba62077ddad5e0cf740009"
        };

        window.FirebaseSDK = {
            firebaseConfig, initializeApp, getAuth, signInAnonymously, 
            onAuthStateChanged, getFirestore, collection, doc, setDoc, 
            addDoc, onSnapshot, deleteDoc
        };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- 3. React 應用邏輯 -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icons = {
            Camera: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.72V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.17a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            History: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            Trash2: ({size=18, className=""}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            CheckCircle2: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            ChevronRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            LayoutDashboard: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>,
            Printer: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Store: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/></svg>,
            AlertTriangle: () => <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('form'); 
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);
            const [stores, setStores] = useState([]);
            const [checklistTemplate, setChecklistTemplate] = useState([]);
            const [historyRecords, setHistoryRecords] = useState([]);
            const [selectedRecord, setSelectedRecord] = useState(null);
            const [confirmDelete, setConfirmDelete] = useState(null);
            
            const [filterStore, setFilterStore] = useState('全部');
            const [filterMonth, setFilterMonth] = useState(''); 

            const [issuePhotos, setIssuePhotos] = useState([]);
            const [formData, setFormData] = useState({
                storeName: '',
                date: new Date().toISOString().split('T')[0],
                supervisor: '',
                shiftStaff: '',
                prevImprovements: '',
                currentImprovements: '',
                overallScore: 'A',
                overallComment: '',
                activeChecklist: []
            });

            const GRADES = ["A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-"];
            const appId = "branch-audit-v50-stable-final";

            useEffect(() => {
                const init = async () => {
                    const sdk = window.FirebaseSDK;
                    if (!sdk || !sdk.firebaseConfig.apiKey || sdk.firebaseConfig.apiKey.includes("請輸入")) {
                        setAuthError("Firebase 配置尚未填寫。");
                        setLoading(false);
                        return;
                    }
                    try {
                        const appInst = sdk.initializeApp(sdk.firebaseConfig);
                        const authInst = sdk.getAuth(appInst);
                        const dbInst = sdk.getFirestore(appInst);
                        await sdk.signInAnonymously(authInst);
                        sdk.onAuthStateChanged(authInst, (u) => {
                            if (u) {
                                setUser(u);
                                setupListeners(sdk, dbInst);
                            }
                        });
                    } catch (err) { setAuthError(err.message); setLoading(false); }
                };

                if (window.FirebaseSDK) init();
                else window.addEventListener('firebase-ready', init);
            }, []);

            const setupListeners = (sdk, db) => {
                const inspectionsCol = sdk.collection(db, 'artifacts', appId, 'public', 'data', 'inspections');
                sdk.onSnapshot(inspectionsCol, (snap) => {
                    const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setHistoryRecords(docs.sort((a, b) => new Date(b.date) - new Date(a.date)));
                });

                const settingsDoc = sdk.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
                sdk.onSnapshot(settingsDoc, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        setStores(data.stores || []);
                        setChecklistTemplate(data.checklistTemplate || []);
                        setFormData(prev => ({
                            ...prev,
                            storeName: prev.storeName || data.stores?.[0] || '',
                            activeChecklist: prev.activeChecklist.length === 0 ? (data.checklistTemplate || []).map(i => ({...i, status: '一般'})) : prev.activeChecklist
                        }));
                    }
                    setLoading(false);
                });
            };

            const saveSettings = async (newStores, newTemplate) => {
                if (!user) return;
                const sdk = window.FirebaseSDK;
                await sdk.setDoc(sdk.doc(sdk.getFirestore(), 'artifacts', appId, 'public', 'data', 'settings', 'config'), { stores: newStores, checklistTemplate: newTemplate });
            };

            const handleStatusChange = (id, status) => {
                setFormData(prev => ({
                    ...prev,
                    activeChecklist: prev.activeChecklist.map(i => i.id === id ? {...i, status} : i)
                }));
            };

            const handlePhotoUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => setIssuePhotos(prev => [...prev, { id: Date.now() + Math.random(), src: reader.result }]);
                    reader.readAsDataURL(file);
                });
            };

            const handleSaveInspection = async () => {
                if (!user) return;
                const sdk = window.FirebaseSDK;
                try {
                    const inspectionsCol = sdk.collection(sdk.getFirestore(), 'artifacts', appId, 'public', 'data', 'inspections');
                    const record = { ...formData, issuePhotos, createdAt: new Date().toISOString() };
                    await sdk.addDoc(inspectionsCol, record);
                    setSelectedRecord(record);
                    setView('report');
                    window.scrollTo(0,0);
                } catch (err) { alert("保存失敗"); }
            };

            const handleDeleteRecord = async (id) => {
                if (!user) return;
                const sdk = window.FirebaseSDK;
                try {
                    await sdk.deleteDoc(sdk.doc(sdk.getFirestore(), 'artifacts', appId, 'public', 'data', 'inspections', id));
                    setConfirmDelete(null);
                } catch (err) { alert("刪除失敗"); }
            };

            const categories = useMemo(() => [...new Set(formData.activeChecklist.map(i => String(i.category)))], [formData.activeChecklist]);

            if (loading || authError) return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center text-white p-6 text-center">
                    {authError ? <div className="space-y-4 font-black text-red-500">連線異常: {authError}</div> : <div className="animate-pulse font-black uppercase tracking-widest opacity-40">System Initializing...</div>}
                </div>
            );

            if (view === 'history') {
                const filtered = historyRecords.filter(r => {
                    const matchStore = filterStore === '全部' || r.storeName === filterStore;
                    const matchMonth = !filterMonth || String(r.date).startsWith(filterMonth);
                    return matchStore && matchMonth;
                });

                return (
                    <div className="min-h-screen bg-slate-50 pb-24 font-sans">
                        <nav className="bg-slate-900 text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-xl">
                            <div className="flex items-center gap-3"><Icons.History className="text-blue-400" /><h1 className="font-black text-xl tracking-tighter">紀錄歷史中心</h1></div>
                            <button onClick={() => setView('form')} className="bg-slate-800 px-5 py-2 rounded-xl text-sm font-bold border border-slate-700 active:scale-95 transition-all">返回</button>
                        </nav>
                        <div className="max-w-3xl mx-auto p-4 space-y-4">
                            <section className="bg-white p-5 rounded-3xl shadow-sm border border-slate-200 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase">分店</label>
                                    <select className="w-full bg-slate-100 p-3 rounded-xl text-sm font-bold border-none outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer" value={filterStore} onChange={e => setFilterStore(e.target.value)}>
                                        <option>全部</option>{stores.map(s => <option key={s}>{s}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase">月份</label>
                                    <input type="month" className="w-full bg-slate-100 p-3 rounded-xl text-sm font-bold border-none outline-none focus:ring-2 focus:ring-blue-500" value={filterMonth} onChange={e => setFilterMonth(e.target.value)} />
                                </div>
                            </section>
                            <div className="grid gap-4">
                                {filtered.map(r => {
                                    const [y, m] = String(r.date).split('-');
                                    return (
                                        <div key={r.id} className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden flex flex-col sm:flex-row transition-all hover:shadow-lg animate-in slide-in-from-bottom-2 duration-300 group">
                                            <div className="bg-slate-900 text-white px-6 py-4 flex flex-row sm:flex-col items-center justify-between sm:justify-center min-w-[110px]">
                                                <div className="flex flex-col items-start sm:items-center">
                                                    <span className="text-[10px] font-black opacity-40 uppercase">{y}</span>
                                                    <span className="text-2xl font-black leading-none">{m}月</span>
                                                </div>
                                                <div className="sm:hidden font-black text-blue-400 text-lg">{String(r.overallScore)}</div>
                                            </div>
                                            <div onClick={() => { setSelectedRecord(r); setView('report'); window.scrollTo(0,0); }} className="flex-1 p-5 flex flex-col justify-center cursor-pointer hover:bg-slate-50 transition-colors">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h4 className="font-black text-xl text-slate-800 tracking-tight">{String(r.storeName)}</h4>
                                                        <div className="flex flex-wrap items-center gap-3 mt-1.5 text-[10px] font-bold text-slate-400 uppercase">
                                                            <span>日期: {String(r.date)}</span>
                                                            <span className="bg-slate-100 px-2 py-0.5 rounded text-slate-500">主管: {String(r.supervisor)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="hidden sm:block text-right">
                                                        <div className="text-3xl font-black text-blue-600 leading-none">{String(r.overallScore)}</div>
                                                        <div className="text-[9px] font-bold text-slate-300 uppercase mt-1 tracking-widest">GRADE</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 border-t sm:border-t-0 sm:border-l border-slate-100 px-4 flex items-center justify-between sm:justify-center gap-2 py-3 sm:py-0">
                                                <button onClick={() => { setSelectedRecord(r); setView('report'); window.scrollTo(0,0); }} className="flex-1 sm:flex-none p-3 text-slate-400 hover:text-blue-600 transition-colors flex justify-center"><Icons.ChevronRight size={24} /></button>
                                                <button onClick={(e) => { e.stopPropagation(); setConfirmDelete(r.id); }} className="flex-1 sm:flex-none p-3 text-slate-300 hover:text-red-500 border-l border-slate-100 transition-colors flex justify-center"><Icons.Trash2 size={20} /></button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        {confirmDelete && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-6 animate-in fade-in duration-200">
                                <div className="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl text-center space-y-6 border border-slate-100">
                                    <div className="w-16 h-16 bg-red-100 text-red-600 rounded-3xl flex items-center justify-center mx-auto rotate-12"><Icons.AlertTriangle size={32} /></div>
                                    <h3 className="text-xl font-black text-slate-800 tracking-tighter">確定要刪除這筆紀錄？</h3>
                                    <div className="flex gap-3 pt-2">
                                        <button onClick={() => setConfirmDelete(null)} className="flex-1 py-4 bg-slate-100 text-slate-500 font-black rounded-2xl hover:bg-slate-200">取消</button>
                                        <button onClick={() => handleDeleteRecord(confirmDelete)} className="flex-1 py-4 bg-red-600 text-white font-black rounded-2xl shadow-lg shadow-red-200 active:scale-95 transition-all">確定刪除</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (view === 'manage') {
                return (
                    <div className="min-h-screen bg-slate-50 pb-24 font-sans">
                        <nav className="bg-slate-900 text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-xl">
                            <div className="flex items-center gap-2 font-black text-xl italic tracking-tighter"><Icons.Settings className="text-blue-400" /> 系統設定 v5.0 Pro</div>
                            <button onClick={() => setView('form')} className="bg-blue-600 px-6 py-2 rounded-xl font-bold active:scale-95 transition-all">儲存並返回</button>
                        </nav>
                        <div className="max-w-xl mx-auto p-4 space-y-10 mt-6">
                            <section className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                                <h2 className="font-black text-slate-800 text-lg mb-6 flex items-center gap-2 border-b pb-4"><Icons.Store className="text-blue-500" /> 分店名單管理</h2>
                                <div className="flex flex-wrap gap-2">
                                    {stores.map(s => (
                                        <div key={s} className="bg-slate-100 px-4 py-2 rounded-xl flex items-center gap-2 border border-slate-200 group transition-all">
                                            <span className="text-xs font-bold text-slate-700">{s}</span>
                                            <button onClick={() => { if(confirm('刪除分店？')){ const n = stores.filter(x => x !== s); setStores(n); saveSettings(n, checklistTemplate); } }} className="text-slate-300 hover:text-red-500 transition-all"><Icons.Trash2 size={14}/></button>
                                        </div>
                                    ))}
                                    <button onClick={() => { const name = prompt("門店名稱："); if(name) { const next = [...stores, name]; setStores(next); saveSettings(next, checklistTemplate); } }} className="border-2 border-dashed border-slate-200 px-4 py-2 rounded-xl text-slate-400 font-bold text-xs hover:border-blue-400 transition-all">+ 新增</button>
                                </div>
                            </section>
                            <section className="space-y-4">
                                <h2 className="font-black text-slate-800 text-lg flex items-center gap-2 px-2 underline decoration-blue-500 decoration-4">巡檢範本項目管理</h2>
                                {categories.map(cat => (
                                    <div key={cat} className="space-y-2">
                                        <h3 className="font-black text-slate-400 text-[10px] uppercase tracking-widest px-2">{cat}</h3>
                                        <div className="space-y-2">
                                            {checklistTemplate.filter(i => String(i.category) === cat).map(item => (
                                                <div key={item.id} className="bg-white p-4 rounded-2xl border border-slate-100 flex items-center gap-3">
                                                    <input type="text" value={item.item} onChange={(e) => { const n = checklistTemplate.map(i => i.id === item.id ? {...i, item: e.target.value} : i); setChecklistTemplate(n); saveSettings(stores, n); }} className="flex-1 bg-transparent border-none text-sm font-bold text-slate-700 p-0 focus:ring-0" />
                                                    <button onClick={() => { const n = checklistTemplate.filter(i => i.id !== item.id); setChecklistTemplate(n); saveSettings(stores, n); }} className="text-slate-200 hover:text-red-500 transition-colors"><Icons.Trash2 size={16}/></button>
                                                </div>
                                            ))}
                                            <button onClick={() => { const n = [...checklistTemplate, { id: Date.now(), category: cat, item: '點擊編輯新項目...' }]; setChecklistTemplate(n); saveSettings(stores, n); }} className="w-full py-2 border-2 border-dashed border-slate-100 rounded-xl text-[10px] font-black text-slate-300 hover:text-blue-500 transition-all">+ 新增項目</button>
                                        </div>
                                    </div>
                                ))}
                            </section>
                        </div>
                    </div>
                );
            }

            if (view === 'report' && selectedRecord) {
                const r = selectedRecord;
                return (
                    <div className="min-h-screen bg-slate-50 p-2 sm:p-10 font-sans text-slate-900">
                        <div className="max-w-4xl mx-auto bg-white shadow-2xl rounded-sm print:shadow-none border-t-[16px] border-slate-900 overflow-hidden">
                            <div className="p-6 sm:p-12 space-y-10">
                                <div className="flex flex-col sm:flex-row justify-between items-start border-b-2 border-slate-100 pb-8 gap-6">
                                    <div>
                                        <h1 className="text-3xl sm:text-5xl font-black text-slate-900 tracking-tighter uppercase mb-4 underline decoration-blue-500 decoration-8 underline-offset-8">巡訪紀錄報告</h1>
                                        <div className="flex items-center gap-4 mt-6">
                                            <span className="bg-slate-900 text-white px-4 py-1.5 font-bold text-xs uppercase rounded-sm">{String(r.storeName)}</span>
                                            <span className="text-slate-400 font-black text-xs uppercase tracking-[0.3em]">{String(r.date)}</span>
                                        </div>
                                    </div>
                                    <div className="print:hidden flex gap-2 w-full sm:w-auto">
                                        <button onClick={() => setView('history')} className="flex-1 sm:flex-none px-6 py-3 border-2 border-slate-900 font-black text-xs uppercase hover:bg-slate-50 transition-all">歷史列表</button>
                                        <button onClick={() => window.print()} className="flex-1 sm:flex-none px-6 py-3 bg-slate-900 text-white font-black text-xs flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all hover:bg-slate-800"><Icons.Printer /> 列印報告</button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-4 border-2 border-slate-900 overflow-hidden print-border">
                                    <div className="p-3 bg-slate-50 border-r border-b-2 border-slate-900 font-black text-[10px] text-slate-500 uppercase print-bg-gray">主管/職稱</div>
                                    <div className="p-3 border-b-2 border-slate-900 font-bold text-sm uppercase">{String(r.supervisor)}</div>
                                    <div className="p-3 bg-slate-50 border-r border-b-2 border-slate-900 font-black text-[10px] text-slate-500 md:border-l uppercase print-bg-gray">值班人員</div>
                                    <div className="p-3 border-b-2 border-slate-900 font-bold text-sm uppercase">{String(r.shiftStaff)}</div>
                                    <div className="p-3 bg-slate-50 border-r border-slate-900 font-black text-[10px] text-slate-500 uppercase tracking-widest print-bg-gray">巡店總評分</div>
                                    <div className="p-3 font-black text-blue-600 text-3xl uppercase">{String(r.overallScore)}</div>
                                    <div className="p-3 bg-slate-50 border-r border-slate-900 font-black text-[10px] text-slate-500 md:border-l uppercase tracking-widest print-bg-gray">雲端狀態</div>
                                    <div className="p-3 font-bold text-[10px] text-green-600 uppercase flex items-center gap-1.5"><Icons.CheckCircle2 className="w-3 h-3" /> CLOUD SYNCED</div>
                                </div>

                                {categories.map(cat => (
                                    <div key={cat} className="space-y-4">
                                        <h3 className="bg-slate-900 text-white px-5 py-2 text-xs font-black uppercase tracking-[0.2em] print-bg-gray">{cat}</h3>
                                        <table className="w-full border-collapse border border-slate-200">
                                            <tbody className="text-sm">
                                                {r.activeChecklist.filter(i => String(i.category) === cat).map((item, idx) => (
                                                    <tr key={idx} className="border-b border-slate-100 transition-colors group">
                                                        <td className="p-4 pr-6 text-slate-700 font-bold leading-relaxed">{String(item.item)}</td>
                                                        <td className="p-4 text-right align-top w-20">
                                                            <span className={`font-black text-[10px] border px-3 py-1 rounded-sm whitespace-nowrap ${item.status === '優' ? 'bg-green-50 border-green-200 text-green-700' : item.status === '一般' ? 'bg-slate-50 border-slate-200 text-slate-400' : 'bg-red-50 border-red-200 text-red-700'}`}>{String(item.status)}</span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ))}
                                {r.issuePhotos?.length > 0 && (
                                    <div className="space-y-6 pt-10 border-t border-slate-100">
                                        <h3 className="font-black text-slate-900 text-xl tracking-tighter decoration-red-500 underline underline-offset-8 decoration-4">現場缺失實拍</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            {r.issuePhotos.map(p => <img key={p.id} src={p.src} className="w-full aspect-video object-cover border border-slate-100 rounded-sm shadow-sm" />)}
                                        </div>
                                    </div>
                                )}
                                <div className="border-4 border-slate-900 p-8 bg-slate-50 relative mt-16 print-border">
                                    <h3 className="font-black text-2xl mb-6 underline underline-offset-8 decoration-slate-300">督導總結建議與指導</h3>
                                    <p className="text-slate-800 italic font-bold leading-loose text-lg whitespace-pre-wrap underline decoration-blue-100 decoration-8 underline-offset-[-2px]">「{r.overallComment || "當次巡視維護優良。"}」</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-100 pb-24 font-sans text-slate-900">
                    <nav className="bg-slate-900 text-white p-5 sticky top-0 z-40 flex justify-between items-center shadow-2xl border-b border-slate-700">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2.5 rounded-2xl shadow-inner shadow-blue-800"><Icons.LayoutDashboard /></div>
                            <div className="flex flex-col">
                                <h1 className="font-black text-xl tracking-tighter uppercase leading-none">分店巡檢系統</h1>
                                <p className="text-[8px] sm:text-[10px] text-slate-500 font-black uppercase tracking-widest mt-1">Audit Cloud Pro v5.0</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('history')} className="bg-slate-800 p-3 rounded-2xl text-blue-400 hover:text-white transition-all active:scale-90 shadow-lg" title="歷史紀錄"><Icons.History /></button>
                            <button onClick={() => setView('manage')} className="bg-slate-800 p-3 rounded-2xl text-slate-400 hover:text-white transition-all active:scale-90 shadow-lg" title="設定"><Icons.Settings /></button>
                            <button onClick={handleSaveInspection} className="bg-white text-slate-900 px-6 py-2.5 rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all hover:bg-blue-50">保存紀錄</button>
                        </div>
                    </nav>

                    <div className="max-w-2xl mx-auto p-4 space-y-8 mt-6">
                        <section className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 space-y-8 animate-in fade-in duration-500">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-black italic">01</div>
                                <h2 className="font-black text-xl uppercase tracking-tight italic underline decoration-blue-500 decoration-4 underline-offset-8">基礎巡視欄位</h2>
                            </div>
                            <div className="space-y-6">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">選擇巡視門店</label>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                        {stores.map(name => (
                                            <button key={String(name)} onClick={() => setFormData({...formData, storeName: String(name)})} className={`py-3 px-1 rounded-2xl text-[10px] font-black border-2 transition-all ${formData.storeName === String(name) ? 'bg-blue-600 border-blue-600 text-white shadow-xl scale-105' : 'bg-slate-50 border-slate-100 text-slate-500 hover:border-blue-200 hover:bg-white'}`}>{String(name)}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input type="text" placeholder="巡視主管姓名" value={formData.supervisor} onChange={e => setFormData({...formData, supervisor: e.target.value})} className="w-full bg-slate-50 border-none rounded-2xl p-4 font-black text-sm focus:ring-4 focus:ring-blue-100 outline-none transition-all" />
                                    <input type="text" placeholder="當班值班人員" value={formData.shiftStaff} onChange={e => setFormData({...formData, shiftStaff: e.target.value})} className="w-full bg-slate-50 border-none rounded-2xl p-4 font-black text-sm focus:ring-4 focus:ring-blue-100 outline-none transition-all" />
                                </div>
                            </div>
                        </section>

                        <section className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 space-y-6 animate-in fade-in delay-150 duration-500">
                            <h2 className="font-black text-xl text-slate-800 uppercase tracking-tight italic underline decoration-amber-500 decoration-4 underline-offset-8 flex items-center gap-2">02 改善內容追蹤</h2>
                            <div className="space-y-4">
                                <textarea className="w-full bg-amber-50 border-none rounded-[1.8rem] p-6 text-sm font-bold text-amber-900 min-h-[110px] shadow-inner focus:ring-2 focus:ring-amber-200 outline-none" placeholder="上月尚未執行完成之項目..." value={formData.prevImprovements} onChange={e => setFormData({...formData, prevImprovements: e.target.value})} />
                                <textarea className="w-full bg-blue-50 border-none rounded-[1.8rem] p-6 text-sm font-bold text-blue-900 min-h-[110px] shadow-inner focus:ring-2 focus:ring-blue-200 outline-none" placeholder="本次巡視發現之主要缺失..." value={formData.currentImprovements} onChange={e => setFormData({...formData, currentImprovements: e.target.value})} />
                            </div>
                        </section>

                        <div className="space-y-12">
                            {categories.map((cat) => (
                                <div key={cat} className="space-y-5 animate-in fade-in duration-700">
                                    <div className="flex items-center gap-4 px-4"><div className="h-8 w-1.5 bg-slate-900 rounded-full shadow-lg"></div><h3 className="font-black text-slate-500 text-sm uppercase tracking-[0.3em]">{cat}</h3></div>
                                    <div className="space-y-4">
                                        {formData.activeChecklist.filter(item => String(item.category) === cat).map(item => (
                                            <div key={item.id} className="bg-white rounded-[2.2rem] p-6 shadow-sm border border-transparent active:border-blue-100 transition-all space-y-5 group">
                                                <p className="font-black text-slate-700 text-sm sm:text-base leading-relaxed pr-8">{String(item.item)}</p>
                                                <div className="flex gap-2">
                                                    {['差', '一般', '優'].map(s => (
                                                        <button
                                                            key={s}
                                                            onClick={() => handleStatusChange(item.id, s)}
                                                            className={`flex-1 py-4 rounded-2xl text-[10px] font-black transition-all ${
                                                                item.status === s 
                                                                    ? s === '優' ? 'bg-green-500 text-white shadow-xl scale-105 shadow-green-200' : s === '一般' ? 'bg-slate-700 text-white shadow-xl scale-105 shadow-slate-300' : 'bg-red-500 text-white shadow-xl scale-105 shadow-red-200'
                                                                    : 'bg-slate-100 text-slate-400 hover:bg-slate-200 hover:bg-white'
                                                            }`}
                                                        >
                                                            {s}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <section className="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 space-y-8 animate-in fade-in duration-500">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center font-black italic">03</div>
                                <h2 className="font-black text-xl uppercase tracking-tight italic underline decoration-red-500 decoration-4 underline-offset-8">缺失照片錄入</h2>
                            </div>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                {issuePhotos.map(p => (
                                    <div key={p.id} className="relative aspect-square rounded-[1.5rem] overflow-hidden shadow-md group border-2 border-white transition-all hover:scale-95">
                                        <img src={p.src} className="w-full h-full object-cover" />
                                        <button onClick={() => setIssuePhotos(issuePhotos.filter(x => x.id !== p.id))} className="absolute top-2 right-2 bg-black/60 text-white p-2 rounded-full backdrop-blur-md opacity-100 transition-opacity"><Icons.Trash2 size={16}/></button>
                                    </div>
                                ))}
                                <label className="aspect-square bg-slate-50 border-4 border-dashed border-slate-200 rounded-[1.5rem] flex flex-col items-center justify-center gap-2 cursor-pointer text-slate-300 hover:text-blue-500 hover:bg-blue-50 hover:border-blue-200 transition-all shadow-inner">
                                    <Icons.Camera size={44} strokeWidth={1.5} /><span className="text-[10px] font-black uppercase tracking-widest text-center px-4 leading-tight">新增拍照</span>
                                    <input type="file" multiple accept="image/*" className="hidden" onChange={handlePhotoUpload} />
                                </label>
                            </div>
                        </section>

                        <section className="bg-slate-900 rounded-[3.5rem] p-8 sm:p-12 space-y-10 text-white shadow-2xl relative overflow-hidden mb-10">
                            <div className="absolute top-0 right-0 w-40 h-40 bg-blue-600/10 rounded-full -mr-20 -mt-20 blur-3xl"></div>
                            <div className="space-y-6 text-center">
                                <h2 className="font-black text-2xl italic flex items-center justify-center gap-2"><Icons.CheckCircle2 className="text-blue-400" /> FINAL GRADE 評分級別</h2>
                                <div className="relative">
                                    <select 
                                        className="w-full bg-slate-800 border-2 border-slate-700 rounded-2xl p-6 text-3xl font-black text-blue-400 outline-none focus:border-blue-500 appearance-none text-center cursor-pointer transition-all shadow-inner"
                                        value={formData.overallScore}
                                        onChange={e => setFormData({...formData, overallScore: e.target.value})}
                                    >
                                        {GRADES.map(g => <option key={g} value={g} className="bg-slate-800">{g}</option>)}
                                    </select>
                                    <div className="absolute right-8 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500"><Icons.ChevronRight className="rotate-90" /></div>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-[0.4em] ml-2">巡店總結指導與督導建議錄入</label>
                                <textarea className="w-full bg-slate-800 border-none rounded-[2rem] p-8 text-lg font-bold text-white min-h-[220px] shadow-inner outline-none focus:ring-4 focus:ring-blue-500/10 leading-loose transition-all" placeholder="請輸入工作指導建議..." value={formData.overallComment} onChange={e => setFormData({...formData, overallComment: e.target.value})} />
                            </div>
                            <button onClick={handleSaveInspection} className="w-full bg-white text-slate-900 py-8 rounded-[2rem] font-black text-2xl shadow-[0_20px_50px_rgba(0,0,0,0.3)] active:scale-95 transition-all flex items-center justify-center gap-4 hover:bg-blue-50">
                                <Icons.FileText size={32} /> 提交保存巡檢紀錄
                            </button>
                        </section>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>